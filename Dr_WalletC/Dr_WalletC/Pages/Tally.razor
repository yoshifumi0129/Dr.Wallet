@page "/tallys"
@using Dr_WalletC.Data;
@using Dr_WalletC.Models
@using Microsoft.EntityFrameworkCore;
@inject ApplicationDbContext _context
@inject IJSRuntime JSRuntime
@using Microsoft.AspNetCore.Identity
@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<IdentityUser> UserManager
@using System.Security.Claims

<PageTitle>Counter</PageTitle>

<SfDashboardLayout Columns="6"  AllowResizing=true>
    <DashboardLayoutPanels >
        <DashboardLayoutPanel Column="0" Row="0" SizeX="2" SizeY="1">
            <HeaderTemplate>収入</HeaderTemplate>
            <ContentTemplate>
                <h1>@SumIncome</h1>
            </ContentTemplate>
        </DashboardLayoutPanel>
        <DashboardLayoutPanel Column="2" Row="0" SizeX="2" SizeY="1">
            <HeaderTemplate>支出</HeaderTemplate>
            <ContentTemplate>
                <h1>@SumExpense</h1>
            </ContentTemplate>
        </DashboardLayoutPanel>
        <DashboardLayoutPanel Column="4" Row="0" SizeX="2" SizeY="1">
            <HeaderTemplate>残高</HeaderTemplate>
            <ContentTemplate>
               <h1>@Balance</h1>
            </ContentTemplate>
        </DashboardLayoutPanel>
        <DashboardLayoutPanel Column="0" Row="1" SizeX="3" SizeY="3">
            <HeaderTemplate>支出の割合</HeaderTemplate>
            <ContentTemplate>
                <button class="btn btn-primary btn-sm py-0" onclick="pieChartTest(@Food1,@Hobby2,@Carfare3,@Clothes4,@Expenses5,@Education6,@Water7,@Communication8,@Rent9,@Insurance10)">Click me</button>
                <div class="chart-container" style="position: relative; height:400px; width:600px ">
                    <canvas id="myChart" style="text-align:center"></canvas>
                </div>
            </ContentTemplate>
        </DashboardLayoutPanel>
        <DashboardLayoutPanel Column="4" Row="1" SizeX="3" SizeY="3">
            <HeaderTemplate>カテゴリー別合計</HeaderTemplate>
            <ContentTemplate>
                <h2>食費 @Food1</h2>
                <h2>趣味・娯楽 @Hobby2</h2>
                <h2>交通費 @Carfare3</h2>
                <h2>衣服・美容 @Clothes4</h2>
                <h2>特別費 @Expenses5</h2>
                <h2>教養・教育 @Education6</h2>
                <h2>水道費 @Water7</h2>
                <h2>通信費 @Communication8</h2>
                <h2>家賃 @Rent9</h2>
                <h2>税・保険 @Insurance10</h2>
            </ContentTemplate>
        </DashboardLayoutPanel>
    </DashboardLayoutPanels>
</SfDashboardLayout>

@* <h1>Hello, world!</h1>
<h5>ログインユーザID: @userId</h5>
<h5>ログインユーザ名: @loginName</h5>
<h5>@nowDt </h5> *@

@foreach (var items in Expense)
{
    SumExpense += items.Price;
}
@foreach (var items in Income)
{
    SumIncome += items.Price;
}
@{
    Balance = SumIncome - SumExpense;
}
@foreach (var items in Food)
{
    Food1 += items.Price;
}
@foreach (var items in Hobby)
{
    Hobby2 += items.Price;
}
@foreach (var items in Carfare)
{
    Carfare3 += items.Price;
}
@foreach (var items in Clothes)
{
    Clothes4 += items.Price;
}
@foreach (var items in Expenses)
{
    Expenses5 += items.Price;
}
@foreach (var items in Education)
{
    Education6 += items.Price;
}

@foreach (var items in Water)
{
    Water7 += items.Price;
}
@foreach (var items in Communication)
{
    Communication8 += items.Price;
}
@foreach (var items in Rent)
{
    Rent9 += items.Price;
}
@foreach (var items in Insurance)
{
    Insurance10 += items.Price;
}



<style>
    .e-panel-header{
        text-align:center
    }
    .e-panel-content{
        text-align:center;
        margin-top:10px;
    }
</style>

@code{
    public IList<Balance> Expense { get; set; }
    public IList<Balance> Income { get; set; }
    public IList<Balance> Food { get; set; }
    public IList<Balance> Hobby { get; set; }
    public IList<Balance> Carfare { get; set; }
    public IList<Balance> Clothes { get; set; }
    public IList<Balance> Expenses { get; set; }
    public IList<Balance> Education { get; set; }
    public IList<Balance> Water { get; set; }
    public IList<Balance> Communication { get; set; }
    public IList<Balance> Rent { get; set; }
    public IList<Balance> Insurance { get; set; }


    public int IncomeSUM{ get; set; }

    public int SumExpense { get; set; }
    public int SumIncome { get; set; }
    public int Balance { get; set; }

    public int Food1 { get; set; }
    public int Hobby2 { get; set; }
    public int Carfare3 { get; set; }
    public int Clothes4 { get; set; }
    public int Expenses5 { get; set; }
    public int Education6 { get; set; }
    public int Water7{ get; set; }
    public int Communication8{ get; set; }
    public int Rent9 { get; set; }
    public int Insurance10{ get; set; }

    private string loginName = "";
    private Balance balance = new Balance();
    private string errorMessage = "";

    private string userId;
    private DateTime nowDt = DateTime.Now;
    protected override async Task OnInitializedAsync()
    {
        // AuthenticationStateProviderから現在の認証状態を取得
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var authuser = authState.User;
        // ユーザーが認証済みの場合は、Identity.Nameからログイン名を取得して返す
        if (authuser.Identity.IsAuthenticated)
        {
            // ログイン名取得
            loginName = authuser.Identity.Name;
            // ログインID取得
            userId = authuser.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            balance.UserAccountId = userId;
            // var obj = DateTime.SpecifyKind(nowDt, DateTimeKind.Utc);
            // balance.DateTime = obj;
            balance.DateTime = nowDt.ToUniversalTime();

            IQueryable<Balance> reslutE = _context.Balance.FromSqlRaw($"SELECT * FROM \"Balance\" WHERE \"Bop\" = '支出' AND \"UserAccountId\" = '{userId}'");

            IQueryable<Balance> reslutI = _context.Balance.FromSqlRaw($"SELECT * FROM \"Balance\" WHERE \"Bop\" = '収入' AND \"UserAccountId\" = '{userId}'");

            IQueryable<Balance> reslut1 = _context.Balance.FromSqlRaw($"SELECT * FROM \"Balance\" WHERE \"CategoryId\" = 1 AND \"UserAccountId\" = '{userId}'");

            IQueryable<Balance> reslut2 = _context.Balance.FromSqlRaw($"SELECT * FROM \"Balance\" WHERE \"CategoryId\" = 2 AND \"UserAccountId\" = '{userId}'");

            IQueryable<Balance> reslut3 = _context.Balance.FromSqlRaw($"SELECT * FROM \"Balance\" WHERE \"CategoryId\" = 3 AND \"UserAccountId\" = '{userId}'");

            IQueryable<Balance> reslut4 = _context.Balance.FromSqlRaw($"SELECT * FROM \"Balance\" WHERE \"CategoryId\" = 4 AND \"UserAccountId\" = '{userId}'");

            IQueryable<Balance> reslut5 = _context.Balance.FromSqlRaw($"SELECT * FROM \"Balance\" WHERE \"CategoryId\" = 5 AND \"UserAccountId\" = '{userId}'");

            IQueryable<Balance> reslut6 = _context.Balance.FromSqlRaw($"SELECT * FROM \"Balance\" WHERE \"CategoryId\" = 6 AND \"UserAccountId\" = '{userId}'");

            IQueryable<Balance> reslut7 = _context.Balance.FromSqlRaw($"SELECT * FROM \"Balance\" WHERE \"CategoryId\" = 7 AND \"UserAccountId\" = '{userId}'");

            IQueryable<Balance> reslut8 = _context.Balance.FromSqlRaw($"SELECT * FROM \"Balance\" WHERE \"CategoryId\" = 8 AND \"UserAccountId\" = '{userId}'");

            IQueryable<Balance> reslut9 = _context.Balance.FromSqlRaw($"SELECT * FROM \"Balance\" WHERE \"CategoryId\" = 9 AND \"UserAccountId\" = '{userId}'");

            IQueryable<Balance> reslut10 = _context.Balance.FromSqlRaw($"SELECT * FROM \"Balance\" WHERE \"CategoryId\" = 10 AND \"UserAccountId\" = '{userId}'");

            Food = reslut1.ToList();
            Hobby = reslut2.ToList();
            Carfare = reslut3.ToList();
            Clothes = reslut4.ToList();
            Expenses = reslut5.ToList();
            Education = reslut6.ToList();
            Water = reslut7.ToList();
            Communication = reslut8.ToList();
            Rent = reslut9.ToList();
            Insurance = reslut10.ToList();



            Expense = reslutE.ToList();
            Income = reslutI.ToList();
        }
    }

    //同期処理
    // protected override  void OnInitialized()
    // {
      
    //     IQueryable<Balance> reslutE = _context.Balance.FromSqlRaw($"SELECT * FROM \"Balance\" WHERE \"Bop\" = '支出' AND \"UserAccountId\" = '{userId}'");

    //     IQueryable<Balance> reslutI = _context.Balance.FromSqlRaw("SELECT * FROM \"Balance\" WHERE \"Bop\" = '収入' AND \"UserAccountId\" = 'b0204f93-cec6-4079-bab6-c30b6c2c9067'");

    //     IQueryable<Balance> reslut1 = _context.Balance.FromSqlRaw("SELECT * FROM \"Balance\" WHERE \"CategoryId\" = 1 AND \"UserAccountId\" = 'b0204f93-cec6-4079-bab6-c30b6c2c9067'");
        
    //     IQueryable<Balance> reslut2 = _context.Balance.FromSqlRaw("SELECT * FROM \"Balance\" WHERE \"CategoryId\" = 2 AND \"UserAccountId\" = 'b0204f93-cec6-4079-bab6-c30b6c2c9067'");

    //     IQueryable<Balance> reslut3 = _context.Balance.FromSqlRaw("SELECT * FROM \"Balance\" WHERE \"CategoryId\" = 3 AND \"UserAccountId\" = 'b0204f93-cec6-4079-bab6-c30b6c2c9067'");

    //     IQueryable<Balance> reslut4 = _context.Balance.FromSqlRaw("SELECT * FROM \"Balance\" WHERE \"CategoryId\" = 4 AND \"UserAccountId\" = 'b0204f93-cec6-4079-bab6-c30b6c2c9067'");
        
    //     IQueryable<Balance> reslut5 = _context.Balance.FromSqlRaw("SELECT * FROM \"Balance\" WHERE \"CategoryId\" = 5 AND \"UserAccountId\" = 'b0204f93-cec6-4079-bab6-c30b6c2c9067'");
        
    //     IQueryable<Balance> reslut6 = _context.Balance.FromSqlRaw("SELECT * FROM \"Balance\" WHERE \"CategoryId\" = 6 AND \"UserAccountId\" = 'b0204f93-cec6-4079-bab6-c30b6c2c9067'");

    //     IQueryable<Balance> reslut7 = _context.Balance.FromSqlRaw("SELECT * FROM \"Balance\" WHERE \"CategoryId\" = 7 AND \"UserAccountId\" = 'b0204f93-cec6-4079-bab6-c30b6c2c9067'");
     
    //     IQueryable<Balance> reslut8 = _context.Balance.FromSqlRaw("SELECT * FROM \"Balance\" WHERE \"CategoryId\" = 8 AND \"UserAccountId\" = 'b0204f93-cec6-4079-bab6-c30b6c2c9067'");

    //     IQueryable<Balance> reslut9 = _context.Balance.FromSqlRaw("SELECT * FROM \"Balance\" WHERE \"CategoryId\" = 9 AND \"UserAccountId\" = 'b0204f93-cec6-4079-bab6-c30b6c2c9067'");

    //     IQueryable<Balance> reslut10 = _context.Balance.FromSqlRaw("SELECT * FROM \"Balance\" WHERE \"CategoryId\" = 10 AND \"UserAccountId\" = 'b0204f93-cec6-4079-bab6-c30b6c2c9067'");

    //     Food = reslut1.ToList();
    //     Hobby = reslut2.ToList();
    //     Carfare = reslut3.ToList();
    //     Clothes = reslut4.ToList();
    //     Expenses = reslut5.ToList();
    //     Education = reslut6.ToList();
    //     Water = reslut7.ToList();
    //     Communication = reslut8.ToList();
    //     Rent = reslut9.ToList();
    //     Insurance = reslut10.ToList();



    //     Expense = reslutE.ToList();
    //     Income = reslutI.ToList();

    // }
}


